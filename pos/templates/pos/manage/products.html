{% extends "pos/manage/manage.html" %}
{% load staticfiles %}
{% load i18n %}

{% block head %}

<script type="text/javascript">
categories = []; // list of pairs "label", "value"
units = [];
all_discounts = {};

var last_value;
var update_timeout;

check_interval_duration = 500;
update_timeout_duration = 1500;

$(document).ready(function(){
    // functions:
    function update_products(){
        // update products when search criteria has changed (gets called on timeout or on click)
        // assemble a JSON object with all search criteria and pass it to the view
        search_criteria = {
            general_filter:$("#general_filter").val(),
        };
        
        if(adv_chk_obj.prop("checked") == true){
            // add criteria from the advanced div
            $(".filter").each(function(){
                if($(this).val()){
                    search_criteria[$(this).attr("id")] = $(this).val(); 
                }
            });
            // add the category id (stored in .data())
            cat_fil_id = "category_filter";
            search_criteria[cat_fil_id] = $("#" + cat_fil_id).data().id;
        }
        
        // send to the view
        send_data("{% url 'pos:search_products' company.url_name %}",
                search_criteria, "{{ csrf_token }}", function(recv_data){
                    show_products(recv_data);
        });
        return false;
    }
    
    function show_products(data){
        // show products that search returned
        // clear products div
        products_div = $("#products_list");
        
        products_div.empty();
        
        if(data.length == 0){
            products_div.append("{% trans 'No products found' %}");
        }
        
        var i;
        for(i=0; i<data.length; i++){
        	// TODO
            div_obj = $("#product_details_template").clone();
            div_obj.removeAttr("id");
            render_product(div_obj, data[i]);
        }
    }
    
    function add_discount(parent, product, key){
        // add a list item and a delete link to product edit dialog
        discount = product.discounts[key];
        
        if(!discount) return;
        
        // tooltip - discount details
        var tooltip = "";
        
        tooltip = discount.code + "<br/>" // discount code
        tooltip += discount.description + "<br/>" // description
        // TODO:
        //tooltip += p.start_date + " - " + p.end_date // start and end date
        // TODO: set style for inactive discount
        if(!discount.active) tooltip += "<br/>{% trans 'inactive' %}" // active
        
        dt = discount.code + " " + discount.amount + " ";
        if(discount.type == "Absolute") dt += "$€Ł"; // TODO: currency
        else dt += "%";
        
        li_obj = $("<li>", {title:tooltip});
        li_obj.append(dt);
        li_obj.tooltip({content:tooltip});
        li_obj.data({id:discount.id}); // store id in data() for later retrieval
        
        // delete button
        btn_obj = $("<input>", {type:"button", value:"x","class":"delete_discount"});
        btn_obj.click(function(){
            delete product.discounts[key]
            refresh_discounts(product);
        });
        li_obj.append(btn_obj);
        
        parent.append(li_obj);
    }
    
    function refresh_discounts(product){
        // clear everything discount-related and redraw
        $("#edit_discounts", edit_div_obj).empty();
        $("#edit_discount_list", edit_div_obj).empty();
        $("#edit_add_discount", edit_div_obj).empty();
        
        // add discounts in product
        for(var key in product.discounts){
            add_discount(ul_obj, product, key);
        }
        
        // add another item, this time with all available discounts
        // in a listbox and an 'add' button
        li_obj = $("<li>")
        sel_obj = $("<select>", {id:"edit_discount_list"});
        btn_obj = $("<input>", {type:"button",value:"{% trans 'Add' %}"});
        li_obj.append(sel_obj);
        li_obj.append(btn_obj);
        li_obj.data({id:false}); // don't store or send this item
        ul_obj.append(li_obj);
        
        // add discounts NOT in product to add listbox
        var added = 0;
        for(var key in all_discounts){
            if(key in product.discounts) continue;
            
            opt_obj = $("<option>")
            .attr("value", key)
            .append(all_discounts[key].code); // TODO: add amount and unit (% or currency)
            
            sel_obj.append(opt_obj);
            added++;
        }
        // only add the listbox if there's anything to add
        if(added > 0){
            // unselect the first item in listbox to avoid confusion
            sel_obj.prop("selectedIndex", -1);
            
            btn_obj.click(function(){ // add button
                d_id = $(":selected", sel_obj).val();
                
                // add data to product
                product.discounts[d_id] = all_discounts[d_id];
                refresh_discounts(product);
            });
        }
        else{
            // remove the last, 'add' entry
            li_obj.remove();
        }
    }
    
    function show_product_edit_dialog(product){
        var i;
        
        // show edit dialog and fill it with current product's data
        edit_div_obj = $("#edit_dialog");
        edit_div_obj.data({id:product.id,
        	edit_url:product.edit_url,
        	delete_url:product.delete_url});
        
        $("#edit_product_name", edit_div_obj).val(product.name);
        $("#edit_product_price", edit_div_obj).val(product.price);
        // ... per unit (listbox with unit types)
        var sel_obj = $("#edit_unit_type", edit_div_obj);    
        
        for(i=0; i<units.length;i++){
            opt_obj = $("<option>")
                .attr("value", units[i].value)
                .text(units[i].name);
            
            if(units[i].value == product.unit_type){
                opt_obj.attr("selected", "selected");
            }
            
            sel_obj.append(opt_obj);
        }
        
        // listbox with categories
        sel_obj = $("#edit_product_category", edit_div_obj);
        
        for(i=0; i < categories.length; i++){
            opt_obj = $("<option>")
            .attr("value", categories[i].value)
            .append(categories[i].label);
            
            if(categories[i].label == product.category){
                opt_obj.attr("selected", "selected");
            }
            sel_obj.append(opt_obj);
        }
        
        // images (?)
        
        // tax
        $("#edit_product_tax", edit_div_obj).val(product.tax);
        $("#edit_product_description", edit_div_obj).val(product.description);
        $("#edit_product_price", edit_div_obj).val(product.price);
        
        // discounts
        // add to list
        ul_obj = $("#edit_discounts", edit_div_obj);
        ul_obj.empty();
        var discount = "";
        var btn_obj = "";
        
        // for the first time
        refresh_discounts(product);
        
        $("#edit_product_private_notes", edit_div_obj).val(product.private_notes);
        $("#edit_product_stock", edit_div_obj).val(product.stock);
        $("#edit_product_shop_code", edit_div_obj).val(product.shop_code);
        $("#edit_product_code", edit_div_obj).val(product.code);
        
        // show the edit dialog
        edit_div_obj.dialog({
            modal: true
        });
        
        // set dialog title
        edit_div_obj.dialog('option', 'title',
                "{% trans 'Edit product' %}: " + product.name);
        edit_div_obj.dialog('option', 'width', 900);
        
        
        // save button
        $("#edit_product_save", edit_div_obj).click(save_product);
        
        // cancel button
        $("#edit_product_cancel", edit_div_obj).click(function(){
           // destroy the dialog and delete all content
           edit_div_obj.dialog(edit_div_obj).dialog("destroy");
        });
    }
    
    function render_product(parent, product){
        var tmp_obj, i;
        
        // product details include:
        // id - goes to $.data() and hidden field
        // name                        | price / unit_type
        //           | category        | tax 
        //   image   | description     | discounts
        //           | private_notes   | stock
        // shop_code | code 
        
        // copy the product details template div and update values
        //div_obj = $("#product_details_template").clone();
        //div_obj.removeAttr("id");
        // TODO
        div_obj = parent;
        
        // add product data to data()
        div_obj.data(product);
        // add id to hidden field
        $(".product_id", div_obj).append(product.id);
        // name
        $(".product_name", div_obj).append(product.name);
        // price and unit
        tmp_obj = $(".product_price", div_obj);
        tmp_obj.append("{% trans 'Price' %}: $€" + product.price +
                "/" + product.unit_type);
        
        // image TODO
        // category
        $(".product_category", div_obj).append("{% trans 'Category' %}: " + product.category);
        // tax
        $(".product_tax", div_obj).append(product.tax + "%");
        // description
        $(".product_description", div_obj).append(product.description);
        // discount list
        tmp_obj = $(".product_discounts", div_obj);
        var li_obj;
        for(var key in product.discounts){
            li_obj = $("<li>");
            // code
            li_obj.append(product.discounts[key].code);
            // amount
            li_obj.append(" ("+product.discounts[key].amount);
            // type
            if(product.discounts[key].type == 'Percent') li_obj.append("%)");
            else li_obj.append(")"); // TODO: currency symbol/code
            tmp_obj.append(li_obj);
        }
        
        // private notes
        $(".product_private_notes", div_obj).append(product.private_notes);
        // stock
        if(product.stock){
            $(".product_stock", div_obj).append(product.stock + " {% trans 'left in stock' %}");
        }
        
        // shop code
        $(".product_shop_code", div_obj).append(product.shop_code);
        // code
        $(".product_code", div_obj).append(product.code);
        
        div_obj.show();
        $("#products_list").append(div_obj);
        
        // edit button
        manage_obj = $(".product_management", div_obj); 
        $("input.product_edit_button", manage_obj).click(function(){
                show_product_edit_dialog(product);
        });
        
        // delete button
        $("input.product_delete_button", manage_obj).click(function(){
           alert("delete"); 
        });
    }
    
    function save_product(){
        // get product's data from the dialog and send
        // id
        // price - numeric value
        // unit type
        // discounts - list of discount ids
        // image - TODO
        // category - id
        // code
        // shop code
        // description
        // private notes
        // tax
        // stock
        
        dlg_obj = $("#edit_dialog");
        
        data = {};
        data['id'] = $("#edit_product_id", dlg_obj).val();
        data['name'] = $("#edit_product_name", dlg_obj).val();
        data['price'] = $("#edit_product_price", dlg_obj).val();
        data['unit_type'] = $("#edit_unit_type :selected", dlg_obj).val();
        // TODO: image
        data['category'] = $("#edit_product_category", dlg_obj).val();
        data['tax'] = $("#edit_product_tax", dlg_obj).val();
        data['description'] = $("#edit_product_description", dlg_obj).val();
        // discounts: get all <li> items and put them into an array
        discounts = [];
        $("ul#edit_discounts li", dlg_obj).each(function(){
            id = $(this).data().id;
            if(id) discounts.push(id); // the last entry is the listbox and button, don't add that
        });
        data['discounts'] = discounts;
        data['private_notes'] = $("#edit_product_private_notes", dlg_obj).val();
        data['stock'] = $("#edit_product_stock", dlg_obj).val();
        data['shop_code'] = $("#edit_product_shop_code", dlg_obj).val();
        data['code'] = $("#edit_product_code", dlg_obj).val();
        
        // send data to server; url is stored in div's data()
        send_data(dlg_obj.data().edit_url, data, "{{csrf_token}}", function(response){
        	if(response.status != 'ok') alert(response.message);
        	else{
        		// close the dialog and redraw product div
        	}
        });
    }
    
    ////////////////////
    // data retrieval
    ////////////////////
    // categories list
    get_data("{% url 'pos:JSON_categories' company.url_name %}",
        function(data){
            // convert categories' data from the server to a list for autocomplete data:
            // (server:client)
            // name > label
            // id > value
            for(var i = 0; i < data.length; i++){
                categories.push({label:data[i].breadcrumbs, value:data[i].id})
            }
            return false;
        }
    );
    
    // unit types
    get_data("{% url 'pos:JSON_units' company.url_name %}",
        function(data){
            for(var i=0; i<data.length; i++){
                units.push({"value":data[i][0], "name":data[i][1]});
            }
            return false;
        }
    );

    // discounts
    get_data("{% url 'pos:JSON_discounts' company.url_name %}",
        function(data){
            all_discounts = data;
        }
    );
    
    // behavior:
    ////////////////////
    // searching
    ////////////////////
    gf_obj = $("#general_filter");
    gf_obj.keypress(function(e){
        if(e.which == 13){ // enter pressed
            update_products();
        }
    });
    
    // hide the template
    $("div#product_details_template").hide();
    $("div#edit_dialog").hide();
    
    // general products search box timers
    setInterval(function(){ // check for change
        new_value = gf_obj.val(); 
        if(last_value != new_value){
            if(new_value.length < 2) return;
            last_value = new_value; // changed, update products
            clearTimeout(update_timeout);
            update_timeout = setTimeout(update_products, update_timeout_duration);
        }
        return false;
    }, check_interval_duration);
        
    // advanced search div
    adv_div_obj = $("#advanced_search"); 
    adv_div_obj.hide();
    
    adv_chk_obj = $("#advanced_search_toggle");
    
    adv_chk_obj.change(function(){
       if(adv_chk_obj.prop("checked") == false){
           adv_div_obj.hide();
       }
       else adv_div_obj.show();
       
       return false;
    });
    
    // categories autocomplete list
    cat_inp_obj = $("#category_filter");
    cat_inp_obj.autocomplete({ source: categories, minLength:0 });
    cat_inp_obj.autocomplete( "option", "delay", check_interval_duration );
    
    cat_inp_obj.focus(function(){
        cat_inp_obj.autocomplete( "search", "" );
    });
    
    cat_inp_obj.on("autocompleteselect", function (e, ui) {
        // override the default autocomplete behavior:
        e.preventDefault(); // prevent the "value" being written to the edit box
        this.value = ui.item.label; // write label
        cat_inp_obj.data("id", ui.item.value); // save the value (category id) to data field
    });
    
    cat_inp_obj.blur(function(){
        // if nothing is selected, remove data from the object
        if(cat_inp_obj.val().length == 0){
            cat_inp_obj.removeData();
        }
    });
    
    // update products on button click
    $("#update_results").click(function(){
        update_products();
    });
    
    ////////////////////
    // product list
    ////////////////////
    
        
        
    
    gf_obj.focus();
});

</script>

{% endblock %}

{% block manage_content %}

{% comment %} filters {% endcomment %}
<div id="filter_form">
    <label for="general_filter">{% trans 'Search' %}:</label><input id="general_filter" class="search_filter" />
    <input type="checkbox" id="advanced_search_toggle" /><label for="advanced_search_toggle">{% trans 'Advanced' %}</label><br />

    <div id="advanced_search">
        {% trans 'Category' %}
        <input id="category_filter" /><!-- this input does not have a "filter" class - the filtering value is stored in data() and needs to be accessed separately from the others -->
        <div id="category_list_select"></div><br />
        
        <label for="product_code_filter">{% trans 'Product code' %}</label><input type="text" id="product_code_filter" class="filter" />
        <label for="shop_code_filter">{% trans 'Shop code' %}</label><input type="text" id="shop_code_filter" class="filter" />
        <label for="name_filter">{% trans 'Name' %}</label><input type="text" id="name_filter" class="filter" />
        <label for="description_filter">{% trans 'Description' %}</label><input type="text" id="description_filter" class="filter" />
        <label for="notes_filter">{% trans 'Notes' %}</label><input type="text" id="notes_filter" class="filter" />
        <label for="tax_filter">{% trans 'Tax' %}</label><input type="text" id="tax_filter" class="filter" />
        <label for="price_filter">{% trans 'Price' %}</label><input type="text" id="price_filter" class="filter" />
        <label for="discount_filter">{% trans 'Discount code' %}</label><input type="text" id="discount_filter" class="filter" />
        <input type="button" id="update_results" value="{% trans 'Update' %}" />
    </div>
</div>
<hr>
<div id="products_list"></div>

{% comment %} a template for editing/adding product (dialog) {% endcomment %}
<div id="edit_dialog">
    <table border="1"> <!-- TODO remove border -->
        <tr>
            <td colspan="2">
                <label for="edit_product_name">{% trans 'Name' %}</label> <input type="text" id="edit_product_name" /></p>
            </td>
            <td>{% comment %} price per unit {% endcomment %}
                <p><label for="edit_product_price">{% trans 'Price' %}</label> <input id="edit_product_price" />
                   <label for="edit_unit_type">{% trans 'per' %}</label><select id="edit_unit_type"></select>
            </td>
        </tr>
        <tr>
            <td rowspan="3" class="product_image"><p>TODO: image</p></td> {% comment %} image spans over 3 rows {% endcomment %}
            {% comment %} list of categories {% endcomment %}
            <td><p><label for="edit_product_category">{% trans 'Category' %}</label>
                <select id="edit_product_category"></select></p></td>
            <td><p><label for="edit_product_tax">{% trans 'Tax' %}</label> <input type="text" id="edit_product_tax" />%</p></td>
        </tr>
        <tr>
            <td><p><label for="edit_product_description">{% trans 'Description' %}</label></p>
                <textarea id="edit_product_description"></textarea></td>
            <td>
                {% comment %} discounts {% endcomment %}
                <p>{% trans 'Discounts' %}</p>
                <ul id="edit_discounts"></ul>
            </td>
        </tr>
        <tr>
            <td><p>{% trans 'Private notes' %}:</p>
                <textarea id="edit_product_private_notes"></textarea>
            </td>
            <td><p><label for="edit_product_stock">{% trans 'Units left in stock' %}</label><input type="text" id="edit_product_stock" /></p></td>
        </tr>
        <tr>
            <td><p><label for="edit_product_shop_code">{% trans 'Shop code' %}</label><input type="text" id="edit_product_shop_code" /></p></td> {% comment %} this row again has 3 columns {% endcomment %}
            <td><p><label for="edit_product_code">{% trans 'Product code' %}</label><input type="text" id="edit_product_code" /></p></td>
            
            <td>
                {% comment %} save/cancel buttons {% endcomment %}
                <p><input type="button" id="edit_product_save" value="{% trans 'Save' %}">
                   <input type="button" id="edit_product_cancel" value="{% trans 'Cancel' %}"></p>
            </td>
        </tr>
    </table>
</div>

{% comment %} a template for viewing products {% endcomment %}
<div id="product_details_template">
    <table border="1"> <!-- TODO remove border -->
        <tr>
            <td colspan="2">
                <input type="hidden" class="product_id" />
                <p class="product_name"></p>
            </td>
            <td><p class="product_price"></p> {% comment %} price per unit {% endcomment %}
            </td>
        </tr>
        <tr>
            <td rowspan="3" class="product_image"></td> {% comment %} image spans over 3 rows {% endcomment %}
            <td><p class="product_category"></p></td>
            <td><p class="product_tax"></p></td>
        </tr>
        <tr>
            <td><p class="product_description"></p></td>
            <td>
                <ul class="product_discounts">
                    {% comment %} a list of discounts {% endcomment %}
                </ul>
            </td>
        </tr>
        <tr>
            <td><p class="product_private_notes"></p></td>
            <td><p class="product_stock"></p></td>
        </tr>
        <tr>
            <td><p class="product_shop_code"></p></td> {% comment %} this row again has 3 columns {% endcomment %}
            <td><p class="product_code"></p></td>
            <td><p class="product_management"><input type="button" value="{% trans 'Edit' %}" class="product_edit_button">
                <input type="button" value="{% trans 'Delete' %}" class="product_delete_button"></p>
            </td>
        </tr>
    </table>
</div>

{% endblock %}

