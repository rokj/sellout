{% extends "pos/manage/manage.html" %}
{% load static %}
{% load i18n %}

{% block section_head %}
<link type="text/css" rel="stylesheet" href="{% static 'css/management/taxes.css' %}" />
<script type="text/javascript">
$(document).ready(function(){
    var taxes = [];

    var items = {
        table: $("#tax_table"),
        list: $("#tax_list"),
        add_button: $("#new_tax"),
        save_button: $("#save_taxes"),
        cancel_button: $("#cancel")
    };

    // buttons buttons buttons
    items.save_button.click(save_taxes);
    items.cancel_button.click(update_taxes);
    items.add_button.click(add_tax);
    
    function update_taxes(){
        // re-create all taxes from tax list
        var i;

        // put all taxes in select box
        items.list.empty();
        items.table.empty();

        for(i = 0; i < taxes.length; i++){
            tax_entry(taxes[i]);
        }
    }

    function add_tax(){
        if({{ edit_permission|lower }}){
            // create a new table entry and a new entry in tax list
            tax_entry({name: "", id: -1, amount: Big(0)});
        }
    }
    
    // (re)draw the taxes table
    function tax_entry(tax){
        var tr_obj = $("<tr>");
        tr_obj.data(tr_obj); // store id and that
        
        // first column: name
        var td_obj = $("<td>");
        var input_obj = $("<input>", {type:"text", "class":"name", value:tax.name});
        if({{ edit_permission|lower}}) td_obj.append(input_obj);
        else td_obj.append(tax.name);
        tr_obj.append(td_obj);
        
        // second column: tax amount
        td_obj = $("<td>");
        if({{ edit_permission|lower }}) td_obj.append($("<input>", {type:"text", "class":"amount", value:tax.amount}));
        else td_obj.append(tax.amount);
        tr_obj.append(td_obj);
        
        // third column: delete button
        td_obj = $("<td>");
        // TODO: button icons
        var del_button = $("<button>", {"class":"delete-tax", title:"{% trans 'Delete tax' %}"})
                .append("X");
        td_obj.append(del_button);
        tr_obj.append(td_obj);

        // append to the table
        items.table.append(tr_obj);

        // create a new entry in tax list
        var option = $("<option>", {value:tax.id}).text(tax.name);
        items.list.append(option);

        // link the two for easier access
        // and save the id for saving later
        tr_obj.data({list_item: option});
        option.data({table_row: tr_obj});

        // select this option if this is the default tax
        if(tax.default) items.list.val(tax.id);

        // the delete button
        if({{ edit_permission|lower }}){
            del_button.click(function(){
                tr_obj.remove();
                option.remove();
            });
        }

        // focus on tax name
        input_obj.focus();

        // when name changes, update the list item
        input_obj.change(function(){
            option.text(input_obj.val());
        });
    }

    function save_taxes(){
        // cycle through the taxes table and add them to a json object, then send it
        var data_to_send = [];
        var valid = true; // if a number is typed in in wrong format, nothing will be sent
        
        $("tr", items.table).each(function(){
            var name = $("input.name", this).val();
            var amount = $("input.amount", this).val();
            
            // if there's no name, ignore that row (the last row is one of them)
            if(!name) return;

            // amount must be entered correctly
            if(!check_number(amount, '{{separator}}')){
                alert("{% trans 'Wrong number format' %}: " + amount);
                valid = false;
            }

            // this is the default tax if the option in data is selected
            var def = $(this).data().list_item.is(":selected");

            data_to_send.push({
                'name':name,
                'amount':amount,
                'default':def,
                'id':$(this).data().id
            });
        });
        
        if(valid){
            send_data(" url 'pos:save_taxes' company.url_name ", data_to_send, "{{ csrf_token }}", function(recv_data){
                if(recv_data.status != 'ok') alert(recv_data.message);
                else{
                    // TODO: show the 'received' info in a more civilized way than alert
                    alert("{% trans 'Saved' %}");
                    get_taxes();
                }
            });
        }
    }

    // get all taxes
    function get_taxes(){
        get_data("{% url 'pos:get_taxes' company.url_name %}", function(data){
            taxes = data;
            update_taxes();
        });
    }
    get_taxes();
});
</script>

{% endblock %}

{% block status_bar_title %} {% trans 'Taxes' %} {% endblock %}

{% block extra_button %}
    <a href="#" id="new_tax" class="extra-button">
        {% trans 'Add Tax' %}</a>
{% endblock %}

{% block manage_content %}
    <p>{% trans 'Choose default tax' %}</p>
    <p class="explanation">
        {% trans 'This will be chosen by default when adding new products' %}
    </p>
    <select id="tax_list"></select>

    <table>
        <thead>
            <tr>
                <td>{% trans 'Name (optional)' %}</td>
                <td>{% trans 'Amount' %} (%)</td>
                <td></td>{% comment %} new and delete buttons {% endcomment %}
            </tr>
        </thead>

        <tbody id="tax_table">

        </tbody>
    </table>

    <div id="tax_footer">
        <div class="form-footer">
            <input type="button" id="cancel" value="{% trans 'Cancel' %}" class="cancel" />
        </div>
        <div class="form-footer">
            <input type="button" id="save_taxes" value="{% trans 'Save' %}" class="ok"/>
        </div>
    </div>

{% endblock %}

