{% extends 'pos/manage/manage.html' %}
{% load static %}
{% load i18n %}

{% block section_head %}
    <script type="text/javascript" src="{% static 'js/jquery.customfileinput.js' %}"></script>

    <style type="text/css">
        #edit_product_image {
            /* some data directly from view */
            width: {{ image_dimensions.0 }}px;
            height: {{ image_dimensions.1 }}px;
            background-size: cover;
            background-position: center center;
        }

        .image-buttons {
            position: relative;
            height: {{ image_dimensions.1 }}px;
        }

        .delete-image-button {
            background-image: url("{% static 'icons/delete_active.png' %}");
            left:  {{ image_dimensions.0 }}px;
        }

        /* button backgrounds: other styling is in management/products.css */
        .product-edit-button {
            background-image: url('{% static 'icons/edit_black.png' %}');
        }

        .product-delete-button {
            background-image: url('{% static 'icons/delete_black.png' %}');
        }

        .product-favorite-button {
            background-image: url('{% static 'icons/favorite_black.png' %}');
        }

        .dark .product-edit-button {
            background-image: url('{% static 'icons/edit_white.png' %}');
        }

        .dark .product-delete-button {
            background-image: url('{% static 'icons/delete_white.png' %}');
        }

        .dark .product-favorite-button {
            background-image: url('{% static 'icons/favorite_white.png' %}');
        }

        .product-favorite-button.active {
            background-image: url('{% static 'icons/favorite_active.png' %}');
        }

    </style>
    <link type="text/css" rel="stylesheet" href="{% static 'css/management/products.css' %}"/>

    <script type="text/javascript">
    $(document).ready(function(){
        // all data (from template)

        // categories
        var category_data = {{ categories|safe }};
        var categories_list = []; // list of category names (source for the autocomplete)
        var categories_by_breadcrumbs = {}; // dictionary path:category_id for saving
        var categories_by_id = {}; // dictionary id:path for loading
        var last_chosen_category = null; // remember the category of last added product and show it in new dialog

        // units
        var units_data = {{ units|safe }};
        var units = [];

        // discounts
        var all_discounts = {{ discounts|safe }};

        // taxes
        var tax_rates = {{ taxes|safe }};

        //
        // functions
        //
        // functions
        function show_image(element, url, name){
            if(!url){
                // show 'placeholder' image
                element.css("background-image", "url('{% static 'images/product_placeholder.png' %}')");
                element.attr("alt", "{% trans 'No image' %}");
            }
            else{
                // show the real image
                element.css("background-image", "url('" + url + "')");
                element.attr("alt", escape(name));
            }
        }

        function tax_select(element, preselected_id, select_none){
            element.empty(); // select element

            var opt_obj;

            for(var i = 0; i < tax_rates.length; i++){
                opt_obj = $("<option>")
                        .attr("value", tax_rates[i].id)
                        .text(escape(tax_rates[i].name) + " (" + tax_rates[i].amount + "%)");

                if(preselected_id == tax_rates[i].id){
                    // select the chosen tax
                    opt_obj.attr("selected", "selected");
                }
                element.append(opt_obj);
            }

            if(preselected_id == null || select_none){
                opt_obj = $("<option>")
                        .attr("value", null)
                        .text("---");

                element.append(opt_obj);

                if(!preselected_id) opt_obj.attr("selected", "selected");
            }
        }

        function get_tax(id){
            // returns the tax object with the given id
            for(var i = 0; i < tax_rates.length; i++){
                if(tax_rates[i].id == id) return tax_rates[i];
            }
            return null;
        }

        function categories_autocomplete(element, preselected_id){
            if(element.data('ui-autocomplete')){
                element.autocomplete("destroy");
            }

            element.autocomplete({
                source: categories_list,
                minLength: 0,
                delay: 500
            });

            if(preselected_id != null || preselected_id != -1){
                element.val(categories_by_id[preselected_id]);
            }
        }

        function discount_amount (discount){
                if(discount.type == 'Percent')
                    return " (" + display_number(discount.amount, "{{ separator }}", {{ decimal_places }}) + "%)";
                else
                    return " ({{currency|escapejs}} " + display_number(discount.amount, "{{ separator }}", {{ decimal_places }}) + ")";
            }

        function discount_tooltip(element, discount){
            // tooltip - discount details
            var tooltip = "";

            // tooltip = discount.code + "<br />" // discount code (already in the li)
            tooltip += escape(discount.description) + "<br />"; // description

            // if no dates are set, show 'no date limit', otherwise 'from ... to ...'
            if(!discount.start_date && !discount.end_date){
                tooltip += "{% trans 'No date limits' %}"
            }
            else{
                if(discount.start_date) tooltip += "{% trans 'from' %} " + escape(discount.start_date);
                if(discount.end_date) tooltip += " {% trans 'to' %} " + escape(discount.end_date);
            }

            // TODO: set style for inactive discount
            if(!discount.active) tooltip += "<br/>{% trans 'inactive' %}"; // active

            element.tooltip({content:tooltip});
        }

        function show_products(data){
            // empty the products div
            var products_div = $("#products_list");

            products_div.empty();
            products = [];

            if(data.length == 0){
                products_div.append("{% trans 'No products found' %}");
            }

            var i, product;
            var max_height = 0;
            for(i = 0; i < data.length; i++){
                product = new Product(data[i]);
                products.push(product);

                // get product container's height
                max_height = Math.max(max_height, product.get_height());
            }

            // in the end, make all products equally high
            $("div.product-details").height(max_height);
        }

        function parse_product_data(product){
            // convert all text numbers in product to Big() numbers
            // price, purchase_price, stock, tax, discounts[amount]
            if(typeof product.price == "string")
                product.price = get_number(product.price, "{{ separator }}");

            if(typeof product.purchase_price == "string")
                product.purchase_price = get_number(product.purchase_price, "{{ separator }}");

            if(typeof product.stock== "string")
                product.stock = get_number(product.stock, "{{ separator }}");

            if(typeof product.tax == "string")
                product.tax = get_number(product.tax, "{{ separator }}");

            for(var i = 0; i < product.discounts.length; i++){
                if(typeof product.discounts[i].amount == "string")
                    product.discounts[i].amount =
                            get_number(product.discounts[i].amount, "{{ separator }}");
            }

            return product;
        }

        //
        // objects
        //
        Search = function(){
            var p = this;

            p.advanced_shown = null;
            p.last_search_value = null;
            p.search_timeout = null;
            p.search_timeout_duration = 1000; // update search n[ms] after last change has been made

            p.url_separator = ':';

            p.items = {
                general_filter: $("#general_filter"),

                advanced_toggle_button: $("#advanced_search_toggle"),
                advanced_div: $("#advanced_search"),

                category_filter: $("#category_filter"),
                product_code_filter: $("#product_code_filter"),
                shortcut_filter: $("#shortcut_filter"),
                name_filter: $("#name_filter"),
                description_filter: $("#description_filter"),
                notes_filter: $("#notes_filter"),
                tax_filter: $("#tax_filter"),
                price_filter: $("#price_filter"),
                discount_filter: $("#discount_filter"),

                search_button: $("#update_results"),

                results_info: $("#results_info"),
                results_count: $("#results_count"),
                edit_container: $("#mass_edit_container"),
                edit_title: $("#mass_edit_title"),
                edit_taxes: $("#mass_edit_tax"),
                edit_discounts: $("#mass_edit_discount")
            };

            // methods
            p.toggle_advanced = function(show){
                if(show){
                    p.items.advanced_div.show();

                    // these show and hide up/down arrows
                    $(".basic", p.items.advanced_toggle_button).hide();
                    $(".advanced", p.items.advanced_toggle_button).show();
                }
                else{
                    p.items.advanced_div.hide();
                    $(".basic", p.items.advanced_toggle_button).show();
                    $(".advanced", p.items.advanced_toggle_button).hide();
                }

                p.advanced_shown = show;
            };

            p.clear = function(){
                // clear all search data
                $(".filter", p.items.advanced_div).val("");
                p.items.general_filter.val("");
            };

            p.match_url = function(){
                // returns true if there was valid data in url, false otherwise
                var s = get_url_hash();
                var args = s.split(p.url_separator);

                // must be two in length
                if(args.length == 2){
                    var type = args[0];
                    var query = args[1];

                    switch(type){
                        case "category":
                            // show advanced search
                            p.toggle_advanced(true);
                            p.clear();

                            // select category id in search box
                            var catid = parseInt(query, 10);

                            if(isNaN(catid)) return;

                            p.items.category_filter.val(categories_by_id[catid]);

                            // do a search in this category
                            p.update_products();

                            break;
                        case "product":
                            // show advanced search
                            p.toggle_advanced(true);
                            p.clear();

                            // fill in the product code
                            p.items.product_code_filter.val(query);

                            // run a search
                            p.update_products();
                            break;
                        default:
                            return;
                    }
                }
            };

            p.update_label = function(count){
                if(count == 0){
                    p.items.results_count.text("{% trans 'No results found' %}");
                    p.items.results_info.css("visibility", "hidden");
                }
                else{
                    p.items.results_count.text("{% trans 'Results found' %}: " + count);
                    p.items.results_info.css("visibility", "visible");

                }
            };

            p.update_products = function(){
                // update products when search criteria has changed (gets called on timeout or on click)
                // assemble a JSON object with all search criteria and pass it to the view
                var search_criteria = {
                    general_filter: $("#general_filter").val()
                };

                if(p.advanced_shown){
                    // add criteria from the advanced div
                    $(".filter").each(function(){
                        if($(this).val()){
                            search_criteria[$(this).attr("id")] = $(this).val();
                        }
                    });

                    var cat_filter_id = p.items.category_filter.attr("id");
                    var cat_val = p.items.category_filter.val();

                    if(cat_val != ""){
                        if(cat_val in categories_by_breadcrumbs){
                            search_criteria[cat_filter_id] = categories_by_breadcrumbs[cat_val];
                        }
                    }
                }

                // send to the view
                send_data("{% url 'pos:search_products' company.url_name %}",
                    search_criteria, "{{ csrf_token }}",
                    function(response){
                        if(response.status && response.status == 'error'){
                            error_message(
                                "{% trans 'Search failed' %}",
                                response.message);
                        }
                        else{
                            p.update_label(response.length);
                            show_products(response);
                        }
                    });
                return false;
            };

            //
            // init
            //

            // bind events:
            // advanced search
            p.items.advanced_toggle_button.unbind().click(function(){
                p.toggle_advanced(!p.advanced_shown);
            });

            // general search: search automatically after change
            p.items.general_filter.unbind().keyup(function(){
                var this_val = p.items.general_filter.val();
                if(this_val.length < 3) return;

                if(p.last_search_value != this_val){
                    p.last_search_value = this_val;

                    if(p.search_timeout) clearTimeout(p.search_timeout);
                    p.search_timeout = setTimeout(function(){
                        p.update_products();
                    }, p.search_timeout_duration);
                }
            });

            p.items.general_filter.keypress(function(e){
                if(e.which == 13) p.update_products();
            });

            // categories autocomplete list
            categories_autocomplete(p.items.category_filter, null);

            // tax rates select
            tax_select(p.items.tax_filter, null, true);

            // search button:
            p.items.search_button.unbind().click(p.update_products);

            // match url: if there's anything in it, fill the search criteria
            p.match_url();

            $(window).on("hashchange", p.match_url);

            // mass edit events
            p.items.edit_container.unbind()
                .mouseover(function(){
                    p.items.edit_title.hide();
                    p.items.edit_taxes.show();
                    p.items.edit_discounts.show();
                })
                .mouseout(function(){
                    p.items.edit_title.show();
                    p.items.edit_taxes.hide();
                    p.items.edit_discounts.hide();
                });

            // prevent any fake links from doing anything
            $("a.fake").click(function(e){
                e.preventDefault();
            });

            p.items.edit_taxes.unbind().click(function(){
                mass_tax.toggle_dialog(true);
            });

            p.items.edit_discounts.unbind().click(function(){
                mass_discount.toggle_dialog(true);
            });
        };


        Product = function(data){
            // shows a search result box for this product
            var p = this;

            p.data = data;

            parse_product_data(data);

            p.parent = $("#products_list");
            p.items = {};

            p.details = null; // the details box

            //
            // methods
            //
            p.get_height = function(){
                return p.items.container.height();
            };

            p.update_favorite_button = function(){
                if(p.data.favorite) p.items.favorite_button.addClass("active");
                else p.items.favorite_button.removeClass("active");
            };

            p.toggle_favorite = function(){
                send_data(
                    "{% url 'pos:toggle_favorite' company.url_name %}",
                    {product_id: p.data.id},
                    "{{ csrf_token }}",
                    function(response){
                        if(response.status != 'ok'){
                            error_message(
                                "{% trans 'Favorite could not be set' %}",
                                response.message);
                        }
                        else{
                            // update product and the button
                            p.data.favorite = response.favorite;
                            p.update_favorite_button();
                        }
                    });
            };

            p.delete_product = function(){
                var data = { id: p.data.id };

                // confirm deletion
                confirmation_dialog(
                    "{% trans 'Are you sure?' context 'confirmation dialog title' %}",
                    "{% trans 'Delete product ' %} '" + p.data.name + "'?",
                        function(){
                            send_data("{% url 'pos:delete_product' company.url_name %}", data, "{{ csrf_token }}",
                                function(response){
                                    if(response.status != 'ok')
                                        error_message(
                                                "{% trans 'Error deleting product' %}",
                                                response.message);
                                    else{
                                        // remove the parent
                                        p.items.container.remove();

                                        // remove the product from the product list
                                        for(var i = 0; i < products.length; i++){
                                            if(products[i].data.id == p.data.id){
                                                remove_from_array(products, i);
                                                break;
                                            }
                                        }
                                }
                            });
                        },
                        function(){}
                );
            };


            //
            // init
            //
            // create all the stuff

            p.items.container = $("<div>", {"class":"product-details"});

            // empty parent and copy all stuff from #product_details_template to it
            p.items.container.empty();
            p.items.container.append($("div.title, div.product-details-image, table.details", "#product_details_template").clone());

            // title (only the row, does not include text)
            p.items.title = $(".title", p.items.container);
            p.items.title.css("background-color", "#" + p.data.color);

            if(is_dark(p.data.color)) p.items.title.addClass("dark");
            else p.items.title.removeClass("dark");


            p.items.name = $(".product-name", p.items.container);
            p.items.name.text(p.data.name);

            p.items.image = $(".product-image", p.items.container);
            show_image(p.items.image, p.data.image, p.data.name);

            p.items.price = $(".product-price", p.items.container);
            p.items.price.text(p.data.price);

            p.items.category = $(".product-category", p.items.container);
            p.items.category.text(p.data.category);

            p.items.tax = $(".product-tax", p.items.container);
            p.items.tax.text(p.data.tax);

            // currently not showing
            //p.items.description = $(".product-description", p.items.container);
            //p.items.discounts = $(".product-discounts", p.items.container);
            //p.items.notes = $(".product-private-notes", p.items.container);

            p.items.shortcut = $(".product-shortcut", p.items.container);
            p.items.shortcut.text(p.data.shortcut);

            p.items.code = $(".product-code", p.items.container);
            p.items.code.text(p.data.code);


            // bind buttons
            p.items.edit_button = $(".product-edit-button", p.items.container);
            p.items.delete_button = $(".product-delete-button", p.items.container);
            p.items.favorite_button = $(".product-favorite-button", p.items.container);

            if({{can_edit|lower}}){
                // enable and add functionality to:
                // edit button
                p.items.edit_button.prop('disabled', false);
                p.items.edit_button.unbind().click(function(){
                    p.details = new ProductDetails(p.data);
                });

                // delete button
                p.items.delete_button.prop('disabled', false);
                p.items.delete_button.unbind().click(function(){
                    p.delete_product();
                });

                // favorite button
                p.items.favorite_button.prop('disabled', false);
                p.items.favorite_button.unbind().click(p.toggle_favorite);
            }
            else{
                // just disable everything
                p.items.edit_button.prop('disabled', true);
                p.items.delete_button.prop('disabled', true);
                p.items.favorite_button.prop('disabled', true);
            }

            p.update_favorite_button();

            p.items.container.appendTo(p.parent).show();

        };

        ProductDetails = function(data){
            var p = this;

            p.data = data;

            parse_product_data(data);

            p.container = $("#edit_dialog");
            p.items = {
                title: $("#edit_dialog_title", p.container),
                name: $("#edit_product_name", p.container),
                description: $("#edit_product_description", p.container),
                code: $("#edit_product_code", p.container),
                tax_sel: $("#edit_product_tax", p.container),
                category: $("#edit_product_category", p.container),
                stock: $("#edit_product_stock", p.container),
                unit_sel: $("#edit_product_unit_type", p.container),
                purchase_price: $("#edit_product_purchase_price", p.container),
                base_price: $("#edit_product_price_without_tax", p.container),
                tax_price: $("#edit_product_price_with_tax", p.container),
                shortcut: $("#edit_product_shortcut", p.container),
                discounts: $("#edit_discounts", p.container),
                total_price: $("#total_price", p.container),
                profit: $("#profit", p.container),
                notes: $("#edit_product_private_notes", p.container),

                image: $("#edit_product_image", p.container),
                upload_image: $("#edit_product_image_upload", p.container),
                delete_image: $("#edit_product_delete_image", p.container),

                save_button: $("#edit_product_save", p.container),
                cancel_button: $("#edit_product_cancel", p.container),

                shadow: $("#dialog_shadow")

            };

            var i, o;

            //
            // methods
            //
            p.show_dialog = function(){
                p.items.shadow
                    .fadeIn("fast", function(){
                            p.container.show();
                            p.items.name.focus();
                    })
                    .unbind()
                    .click(p.cancel_button_action);
            };

            p.cancel_button_action = function(){
                /*confirmation_dialog(  // this is really annoying. TODO: check if anything has changed
                    "{% trans 'Cancel editing' %}",
                    "{% trans 'All changes you made to this product will be lost. Continue?' %}",
                    p.close_dialog,
                    function(){});*/

                // delete image: not in context anymore
                delete p.data.delete_image;

                p.close_dialog();
            };

            p.close_dialog = function(){
                p.container.hide();
                p.items.shadow.fadeOut("fast");
            };

            p.update_unit_types = function(){
                // when the unit types edit changes, update all static labels with the changed units
                var ut = p.items.unit_sel.val();

                var ut_display = ut;

                // try to find a better name (the actual display unit instead of m^2)
                for(var i = 0; i < units.length; i++){
                    if(units[i].value == ut){
                        ut_display = units[i].name;
                        break;
                    }
                }

                $(".unit-readonly", p.container).each(function(){
                    $(this).text(ut_display);
                });
            };

            p.get_discounts = function(){
                // discounts: get all <li> items and put them into an array
                var discounts = [];

                p.items.discounts.children().each(function(){
                    var id = $(this).data().id;
                    if(id){
                        discounts.push($(this).data()); // the last entry is the listbox and button, don't add that
                    }
                });

                return discounts;
            };

            p.update_prices = function(){
                // tax
                var t = get_number(get_tax(p.items.tax_sel.val()).amount, "{{ separator }}");
                if(!t) return; // don't change anything if something is wrong (or not yet entered)

                // price: always get price without tax
                var price = get_number(p.items.base_price.val(), "{{ separator }}");
                if(!price) return;

                // gather all discounts
                var discounts = p.get_discounts();

                // function total_price(tax_first, base_price, tax, discounts, quantity, decimal_places){
                var result = total_price({{tax_first|lower}}, price, t, discounts, Big(1), {{decimal_places}});

                // price without tax
                p.items.base_price.text(display_number(result.base, "{{separator}}", {{ decimal_places }}));

                // price with tax
                p.items.tax_price.text(display_number(result.total, "{{separator}}", {{ decimal_places }}));

                // total price
                p.items.total_price.text(display_number(result.total, "{{separator}}", {{ decimal_places }}));

                // calculate profit and if it's lower than zero, use a different style
                // get the purchase price, if entered
                var purchase_price = get_number(p.items.purchase_price.val(), "{{separator}}");

                if(purchase_price){
                    var profit = result.total_tax_exc.minus(purchase_price);
                    p.items.profit.text(display_number(profit, "{{separator}}", {{ decimal_places }}));

                    if(profit.cmp(Big(0)) < 0){ // use alternate style
                        p.items.profit.addClass("negative-profit");
                    }
                    else{
                        p.items.profit.removeClass("negative-profit");
                    }
                }
                else{
                    p.items.profit.text("");
                }
            };

            p.update_image_delete_button = function(){
                // show the button if there's image or if it hasn't been deleted
                if(p.data.delete_image){
                    p.items.delete_image.hide();
                    return;
                }

                if(p.data.image_data || p.data.image) p.items.delete_image.show();
                else p.items.delete_image.hide();
            };

            p.change_image = function(){
                // get image (base64) and store it to .data()
                var obj = p.items.upload_image.get(0);

                // filetype filter
                var rFilter = /^image\/(?:{{ image_upload_formats|escapejs }})$/i; {% comment %} file formats from globals {% endcomment %}

                var f = obj.files[0];
                if(obj.files && f){ // check for browser compatibility
                    var reader = new FileReader();
                    // read the file
                    reader.onload = function(e){
                        // check file type
                        if (!rFilter.test(f.type)){
                            error_message(
                                "{% trans 'Error while uploading image' %}",
                                "{% trans 'Wrong file type for the uploaded image!' %}"
                            );

                            p.update_image_delete_button();

                            return false;
                        }
                        if(f.size > {{ max_upload_size_bytes|escapejs }}){
                            error_message(
                                "{% trans 'Error while uploading image' %}",
                                "{% trans 'File too large, maximum size for upload is' %} {{ max_upload_size|escapejs }} MB"
                            );

                            p.update_image_delete_button();

                            return false;
                        }

                        // store the file in output
                        p.data.image_data = e.target.result;

                        // preview image
                        // show_image() cannot be used here because we're showing image from data:, no from url
                        p.items.image.css("background-image", "url('" + p.data.image_data + "')");
                        p.items.image.attr("alt", p.data.name);

                        p.update_image_delete_button();

                        // update dialog
                        return true;
                    };

                    reader.readAsDataURL(obj.files[0]);
                    // image will have to be uploaded
                    p.data.change_image = true;
                }
            };

            p.add_discount = function(discount){
                // add a list Item and a delete button to product edit dialog
                // add a discount from all_discounts to product
                var li_obj = $("<li>", {title:""});
                li_obj.data(discount); // store id in data() for later retrieval

                discount_tooltip(li_obj, discount);

                // delete button
                var btn_obj = $("<img>", {"class":"delete-discount hoverable", src: "{% static 'icons/cancel.png' %}"});
                btn_obj.click(function(){
                    // delete this list Item
                    $(this).parent().remove();

                    // delete this id from data.discounts
                    var i = get_index(p.data.discounts, discount.id);

                    if(i != null){
                        remove_from_array(p.data.discounts, i);
                    }

                    // redraw discounts
                    p.refresh_discounts();
                });

                li_obj.append(discount.code + " " + discount_amount(discount));
                li_obj.append(btn_obj);

                p.items.discounts.append(li_obj);
            };

            p.save_product = function(){
                // get product's data from the dialog and send
                // id
                // price - numeric value
                // unit type
                // discounts - list of discount ids
                // image_changed
                // image
                // category - id
                // code
                // shortcut
                // description
                // private notes
                // tax
                // stock
                var data = {};
                data['id'] = p.data.id;
                data['name'] = p.items.name.val();
                data['unit_type'] = p.items.unit_sel.val();

                if(p.data.delete_image){
                    p.data.change_image = true;
                    p.data.image_data = null;
                    p.data.image = null;
                }

                // image: if changed, encode uploaded image to base64
                data['change_image'] = p.data.change_image;
                if(p.data.change_image) data['image'] = p.data.image_data;

                data['category_id'] = categories_by_breadcrumbs[p.items.category.val()];
                last_chosen_category = data['category_id']; // remember the last used
                data['tax_id'] = p.items.tax_sel.val();
                data['description'] = p.items.description.val();
                // discounts: strip off everything but ids

                var discounts = p.get_discounts();
                for(var i = 0; i < discounts.length; i++){
                    discounts[i] = discounts[i].id;
                }
                data['discount_ids'] = discounts;
                data['private_notes'] = p.items.notes.val();
                data['stock'] = p.items.stock.val();
                data['shortcut'] = p.items.shortcut.val();
                data['code'] = p.items.code.val();
                // price: always use base price (without tax)
                data['price'] = p.items.base_price.val();

                if(!data['price']){
                    error_message(
                        "{% trans 'Invalid data' %}",
                        "{% trans 'Please check product price' %}"
                    );

                    return;
                }

                // purchase price
                data['purchase_price'] = p.items.purchase_price.val();

                if(data['id'] == "-1"){
                    // it's a new product
                    // refresh search criteria
                    send_data("{{ add_url|escapejs }}", data, "{{csrf_token}}",
                        function(response){
                            if(response.status != 'ok')
                                error_message("{% trans 'Error saving product' %}", response.message);
                            else{
                                // re-do the current search and close the dialog
                                search.update_products();
                                p.close_dialog();
                            }
                        }
                    );
                }
                else{
                    // the product's been edited
                    // send data to server and update the div with the retrieved 'cleaned' data
                    send_data("{% url 'pos:edit_product' company.url_name %}", data, "{{csrf_token}}",
                        function(response){
                            if(response.status != 'ok')
                                error_message("{% trans 'Error saving product' %}", response.message);
                            else{
                                p.close_dialog();

                                search.update_products();
                            }
                        }
                    );
                }
            };

            p.refresh_discounts = function(){
                // clear everything discount-related and redraw
                p.items.discounts.empty();

                // add discounts currently in product
                var i;
                for(i = 0; i < p.data.discounts.length; i++){
                    p.add_discount(p.data.discounts[i]);
                }

                // add another Item, this time with all available discounts
                // in a listbox and an 'add' button
                var li_obj = $("<li>");
                var sel_obj = $("<select>", {id:"edit_discount_list"});

                li_obj.append(sel_obj);
                li_obj.data({id:false}); // don't store or send this Item
                p.items.discounts.append(li_obj);

                // add discounts NOT in product to add listbox
                var added = 0;

                for(i = 0; i < all_discounts.length; i++){
                    // ignore discounts that are already in product
                    if(get_index(p.data.discounts, all_discounts[i].id) != null){
                        continue;
                    }

                    var opt_obj = $("<option>")
                        .attr("value", all_discounts[i].id)
                        .append(all_discounts[i].code + " " + discount_amount(all_discounts[i]));

                    sel_obj.append(opt_obj);
                    added++;
                }
                // only add the listbox if there's anything to add
                if(added > 0){
                    // unselect the first Item in listbox to avoid confusion
                    sel_obj.prop("selectedIndex", -1);

                    sel_obj.unbind().change(function(){ // no add buttons
                        var d_i = parseInt($(":selected", sel_obj).val()); // currently selected discount's list index

                        // add data to product
                        p.data.discounts.push(all_discounts[get_index(all_discounts, d_i)]);
                        p.refresh_discounts();
                    });
                }
                else{
                    // remove the last, 'add' entry
                    li_obj.remove();
                }

                // make the list sortable, but exclude the last Item
                if(added > 0) p.items.discounts.sortable({items:"li:not(:last)", stop: p.update_prices}); // also update price when sorting stops
                else p.items.discounts.sortable({items:"li"});

                // update total price
                p.update_prices();
            };

            //
            // init
            //

            // dialog title
            if(p.data.name) p.items.title.text("{% trans 'Edit product' %}");
            else p.items.title.text("{% trans 'Add product'  %}");

            // name
            p.items.name.val(p.data.name);

            // description
            p.items.description.val(p.data.description);

            // code
            p.items.code.val(p.data.code);

            // tax
            tax_select(p.items.tax_sel, p.data.tax_id, false);

            // category
            if(p.data.id == -1){
                // a new product: use last category
                categories_autocomplete(p.items.category, null);

                if(last_chosen_category != null)
                    p.items.category.val(categories_by_id[last_chosen_category]);
            }
            else{
                // editing an existing product, use its category
                categories_autocomplete(p.items.category, p.data.category_id);
            }

            // stock
            p.items.stock.val(p.data.stock);

            // ... per unit (listbox with unit types)
            p.items.unit_sel.empty();

            for(i = 0; i < units.length; i++){
                o = $("<option>")
                    .attr("value", units[i].value)
                    .text(units[i].name);

                p.items.unit_sel.append(o);
            }
            p.items.unit_sel.unbind().change(p.update_unit_types);

            // purchase price
            p.items.purchase_price.val(p.data.purchase_price);

            // base price (excluding tax
            p.items.base_price.val(p.data.price);

            // price without tax
            p.items.tax_price.val("");

            // when units change
            p.items.unit_sel.unbind().change(p.update_unit_types);
            p.update_unit_types();

            // when prices change
            $()
                .add(p.items.tax_sel)
                .add(p.items.base_price)
                .add(p.items.purchase_price)
                .add(p.items.tax_price)
                .unbind()
                .change(p.update_prices);

            p.items.base_price.change(function(){
                var base_price = get_number($(this).val(), "{{ separator }}");
                // update price with tax
                var tax = get_number(get_tax(p.items.tax_sel.val()).amount, "{{ separator }}");

                if(!base_price) return;
                if(!tax) return;

                p.items.tax_price.val(display_number(
                        base_price.times(Big(1).plus(tax.div(Big(100)))),
                        "{{ separator }}", {{ decimal_places }}));

                p.update_prices();
            });

            p.items.tax_price.change(function(){
                var tax_price = get_number($(this).val(), "{{ separator }}");
                // update price with tax
                var tax = get_number(get_tax($("#edit_product_tax").val()).amount, "{{ separator }}");

                if(!tax_price) return;
                if(!tax) return;

                p.items.base_price.val(display_number(
                        tax_price.div(Big(1).plus(tax.div(Big(100)))),
                        "{{ separator }}", {{ decimal_places }}));

                p.update_prices();
            });

            p.update_prices();
            p.items.base_price.change();

            // shortcut
            p.items.shortcut.val(p.data.shortcut);

            // discounts
            p.items.discounts.empty();
            p.refresh_discounts();

            // private notes
            p.items.notes.val(p.data.private_notes);

            // image
            show_image(p.items.image, p.data.image, p.data.name);

            p.data.change_image = false;
            p.items.upload_image.unbind().change(p.change_image);

            // delete image button
            p.items.delete_image.unbind().click(function(){
                p.data.delete_image = true;

                show_image(p.items.image, null, "");

                p.update_image_delete_button();
            });

            // save and cancel buttons
            p.items.save_button.unbind().click(function(){
                p.save_product();
            });

            // cancel button
            p.items.cancel_button.unbind().click(p.cancel_button_action);

            // last updates
            p.show_dialog();

            // cosmetics:
            // upload image button width: resize the buttons according to column and image width
            // $(".image-buttons", p.container).width(
            //     $(".management-column", p.container).first().width() - {{ image_dimensions.0 }}
            // );

            p.items.upload_image.customFileInput(p.items.image);
            p.update_image_delete_button();
        };

        MassTaxes = function(){
            var p = this;

            p.dialog = $("#mass_tax_edit_dialog");
            p.items = {
                taxes: $("select", p.dialog),
                apply_button: $(".ok", p.dialog)
            };

            //
            // methods
            //
            p.toggle_dialog = function(show){
                if(show){
                    custom_dialog("{% trans 'Taxes' %}", p.dialog, 300);
                }
                else{
                    p.dialog.close_dialog();
                }
            };

            p.update_taxes = function(){
                // get all ids of products in search results
                var ids = [];

                if(products.length == 0) return;

                for(var i = 0; i < products.length; i++){
                    ids.push(products[i].data.id);
                }

                // get the tax that these products should have
                var tax = parseInt(p.items.taxes.val());

                if(isNaN(tax)){
                    error_message(
                        "{% trans 'Error while setting tax' %}",
                        "{% trans 'Please select a valid tax for your products' %}");
                    return;
                }

                // send everything to server
                var data = {
                    products: ids,
                    action: 'set-tax',
                    id: tax
                };

                send_data("{% url 'pos:mass_edit' company.url_name %}",
                    data, "{{ csrf_token }}", function(response){
                        if(response.status != 'ok'){
                            error_message(
                                "{% trans 'Setting tax failed' %}",
                                response.message);
                        }
                        else{
                            // close this window and repeat search
                            p.toggle_dialog(false);
                            search.update_products();
                        }
                    });
            };

            //
            // init
            //
            // fill the tax list
            tax_select(p.items.taxes, null, false);

            p.items.apply_button.unbind().click(function(){
                p.update_taxes();
            });

        };

        MassDiscounts = function(){
            var p = this;

            p.dialog = $("#mass_discount_edit_dialog");
            p.items = {
                discounts: $(".discounts", p.dialog),
                add_button: $(".add-discount", p.dialog),
                remove_button: $(".remove-discount", p.dialog),
                clear_button: $(".clear-discounts", p.dialog)
            };

            //
            // methods
            //
            p.toggle_dialog = function(show){
                if(show){
                    custom_dialog("{% trans 'Discounts' %}", p.dialog, 300);
                }
                else{
                    p.dialog.close_dialog();
                }
            };

            //
            // init
            //

            // fill the discounts select box
            var i, o, d;

            for(i = 0; i < all_discounts.length; i++){
                d = all_discounts[i];

                o = $("<option>", {value: d.id});
                o.text(d.code + discount_amount(d));
                o.attr("title", discount_tooltip(o, d));

                p.items.discounts.append(o);
            }

            p.get_products = function(){
                var ids = [];

                if(products.length == 0) return null;

                for(var i = 0; i < products.length; i++){
                    ids.push(products[i].data.id);
                }

                return ids;
            };

            p.send_action = function(action, object_id){
                var ids = p.get_products();
                if(!ids) return;


                var data = {
                    products: ids,
                    action: action,
                    id: object_id
                };

                send_data("{% url 'pos:mass_edit' company.url_name %}", data,
                    "{{ csrf_token }}", function(response){
                        if(response.status != 'ok'){
                            error_message(
                                "{% trans 'Error while setting discount' %}",
                                response.message);
                        }
                        else{
                            // search again
                            search.update_products();
                            p.toggle_dialog(false);
                        }
                    });
            };

            p.get_discount_id = function(){
                var id = parseInt(p.items.discounts.val());
                if(isNaN(id)){
                    console.error("No selected discount: " + id);
                    return null;
                }

                return id;
            };

            // bind events on buttons:
            // add discount
            p.items.add_button.unbind().click(function(){
                var id = p.get_discount_id();
                if(id == null) return;

                p.send_action('add-discount', id);
            });

            // remove discount
            p.items.remove_button.unbind().click(function(){
                var id = p.get_discount_id();
                if(id == null) return;

                p.send_action('remove-discount', id);
            });

            p.items.clear_button.unbind().click(function(){
                // no id required here, remove all
                p.send_action('clear-discounts', null);
            });
        };

        /////////////////////////////////////////////////////
        //
        // data from template... make it useful
        //
        var i;

        for(i = 0; i < category_data.length; i++){
            categories_list.push(category_data[i].breadcrumbs);
            categories_by_breadcrumbs[category_data[i].breadcrumbs] = category_data[i].id;
            categories_by_id[category_data[i].id] = category_data[i].breadcrumbs;
        }

        // unit types
        units = [];
        for(i = 0; i < units_data.length; i++){
            units.push({"value": units_data[i][0], "name": units_data[i][1]});
        }

        // discounts
        // convert all amounts to Big() numbers
        for(i = 0; i < all_discounts.length; i++){
            all_discounts[i].amount = get_number(all_discounts[i].amount, "{{ separator }}");
        }

        //
        // objects:
        //
        var search = new Search();
        var products = []; // a list of Product() objects
        var product_details = null; // ProductDetails() object
        var mass_tax = new MassTaxes();
        var mass_discount = new MassDiscounts();

        var add_product_button = $("#add_product");

        if({{ can_edit | lower }}){
            add_product_button.unbind().click(function(){
                var new_product = {
                    id: -1,
                    discounts: [],
                    tax_id: {{ default_tax_id }}
                };

                if(product_details) product_details.close_dialog();
                product_details = new ProductDetails(new_product);

            });
        }
        else{
            add_product_button
                    .unbind()
                    .prop("disabled", true);
        }
    });
    </script>
{% endblock %}

{% block status_bar_title %}{% trans 'Products' %}{% endblock %}

{% block extra_button %}<a id="add_product" class="extra-button">{% trans 'Add product' %}</a>{% endblock %}


{% block manage_content %}
    {% comment %} filters {% endcomment %}
    <div class="left-column">
        <div id="filter_form" class="fake-form">
            <h3>{% trans 'Search' context 'form title' %}</h3>
            <input id="general_filter"
                   class="search-filter"
                   type="text" placeholder="{% trans 'Enter query' context 'search products' %}"/>

            <div id="advanced_search" class="hidden">
                <label for="category_filter">{% trans 'Category' %}:</label>
                <input id="category_filter" type="text" class="filter"/>

                <div id="category_list_select"></div>

                <label for="product_code_filter">{% trans 'Product code' %}:</label>
                <input type="text" id="product_code_filter" class="filter"/>

                <label for="shortcut_filter">{% trans 'Shortcut' %}:</label>
                <input type="text" id="shortcut_filter" class="filter"/>

                <label for="name_filter">{% trans 'Name' %}:</label>
                <input type="text" id="name_filter" class="filter"/>

                <label for="description_filter">{% trans 'Description' %}:</label>
                <input type="text" id="description_filter" class="filter"/>

                <label for="notes_filter">{% trans 'Notes' %}:</label>
                <input type="text" id="notes_filter" class="filter"/>

                <label for="tax_filter">{% trans 'Tax' %}:</label>
                <select id="tax_filter" class="filter"></select>

                <label for="price_filter">{% trans 'Price' %}:</label>
                <input type="text" id="price_filter" class="filter"/>

                <label for="discount_filter">{% trans 'Discount code' %}:</label>
                <input type="text" id="discount_filter" class="filter"/>
            </div>

            <div id="filter_form_controls">
                <div class="split-cell first">
                    <button id="advanced_search_toggle" class="hoverable">
                        <span class="basic">
                            {% trans 'Advanced' %}
                            <img src="{% static 'icons/arrow_white_down.png' %}" alt=""/>
                        </span>
                        <span class="advanced hidden">
                            {% trans 'Basic' %}
                            <img src="{% static 'icons/arrow_white_up.png' %}" alt=""/>
                        </span>
                    </button>
                </div>

                <div class="split-cell last">
                    <input type="button" id="update_results"
                           class="ok hoverable"
                           value="{% trans 'Search' context 'submit button label' %}"/>
                </div>

                <div class="cleared"></div>
            </div>
        </div>
    </div>

    <div class="content">
        <div id="results_info">
            <div id="results_count"></div>

            <div id="mass_edit_container">
                <a href="#" id="mass_edit_title" class="fake mass-edit hoverable">{% trans 'Edit all results' %}</a>

                <a href="#" id="mass_edit_tax" class="fake mass-edit tax hoverable hidden">
                    {% trans 'Taxes' %}
                </a>
                <a href="#" id="mass_edit_discount" class="fake mass-edit discount hoverable hidden">
                    {% trans 'Discounts' %}
                </a>
            </div>
        </div>

        <div id="products_list"></div>

        {% comment %} a template for editing/adding product (dialog) {% endcomment %}
        <div id="dialog_shadow"></div>
        <div id="edit_dialog" class="hidden">
            <h2 id="edit_dialog_title">{# content by js #}</h2>

            <div class="management-column narrow">
                <div class="image-buttons">
                    <button id="edit_product_delete_image"
                            class="delete-image-button no-shadow hoverable"
                            title="{% trans 'Remove image' %}"></button>

                    <form id="edit_product_image_input_form">
                        <input type="file" id="edit_product_image_upload" class="hoverable"/>
                    </form>

                    <div id="edit_product_image"></div>
                </div>

                <div class="form-field clear-floats">
                    <label for="edit_product_name">{% trans 'Name' %}</label>
                    <input type="text" id="edit_product_name" maxlength="{{ field_lengths.name }}"/>
                </div>

                <div class="form-field">
                    <label for="edit_product_description">{% trans 'Description' %}</label>
                    {% comment %} max length for textarea: an artibrary value, not set in database {% endcomment %}
                    <textarea id="edit_product_description" maxlength="2000"></textarea>
                </div>

                <div class="form-field">
                    <label for="edit_product_code">{% trans 'Product code' %}</label>
                    <input type="text" id="edit_product_code" maxlength="{{ field_lengths.code }}"/>
                </div>

            </div>
            <div class="management-column narrow hand-margin-2">

                <div class="form-field">
                    {% comment %} list of tax rates {% endcomment %}
                    <label for="edit_product_tax">{% trans 'Tax' %}</label>
                    <select id="edit_product_tax" name="edit_product_tax"></select>
                </div>

                <div class="form-field">
                    {% comment %} list of categories {% endcomment %}
                    <label for="edit_product_category">{% trans 'Category' %}</label>
                    <input type="text" id="edit_product_category" name="edit_product_category"/>
                </div>

                <div class="form-field">
                    <div class="split-cell first">
                        <label for="edit_product_stock">{% trans 'Stock' %}:</label>
                        <input type="text" id="edit_product_stock" maxlength="{{ field_lengths.stock }}"/>
                    </div>

                    <div class="split-cell last">
                        <label for="edit_product_unit_type">{% trans 'Unit' %}</label>
                        <select id="edit_product_unit_type"></select>
                    </div>

                    <div class="cleared"></div>
                </div>

                <div class="form-field">
                    <div class="split-cell first">
                        <label for="edit_product_purchase_price">{% trans 'Purchase price' %}: </label>
                        <input type="text" id="edit_product_purchase_price"
                               maxlength="{{ field_lengths.purchase_price }}"/>
                    </div>
                    <div class="split-cell last read-only-field">
                        {{ currency }} {% trans 'per' %} <span class="unit-readonly">?</span>
                    </div>

                    <div class="cleared"></div>
                </div>

                <div class="form-field">
                    <div class="split-cell first">
                        <label for="edit_product_price_without_tax">{% trans 'Sell price (excl. tax)' %}: </label>
                        <input type="text" id="edit_product_price_without_tax" maxlength="{{ field_lengths.price }}"/>
                    </div>
                    <div class="split-cell last">
                        <label for="edit_product_price_with_tax">{% trans 'Sell price (incl. tax)' %}: </label>
                        <input type="text" id="edit_product_price_with_tax" maxlength="{{ field_lengths.price }}"/>
                    </div>

                    <div class="cleared"></div>
                </div>

                <div class="form-field">
                    <label for="edit_product_shortcut">{% trans 'Shortcut' %}</label>
                    <input type="text" id="edit_product_shortcut" maxlength="{{ field_lengths.shortcut }}"/>
                </div>

            </div>
            <div class="management-column narrow hand-margin-3">

                <div class="form-field">
                    {% comment %} discounts {% endcomment %}
                    <div class="custom-label">{% trans 'Discounts' %}</div>
                    <p class="custom-label description">{% blocktrans %}
                        Drag to reorder. Total discount will be calculated in the same order as shown here.
                    {% endblocktrans %}</p>
                    <ul id="edit_discounts"></ul>
                    {% comment %} total price, including tax and discounts {% endcomment %}
                </div>

                <div class="form-field">
                    {% comment %} total price and profit {% endcomment %}
                    <div class="split-cell first read-only-field">
                        <div class="custom-label">{% trans 'Total price' %}:</div>
                        <div id="total_price">&nbsp;</div>
                    </div>
                    <div class="split-cell last read-only-field">
                        <div class="custom-label"> {% trans 'Profit' %}:</div>
                        <div id="profit">&nbsp;</div>
                    </div>

                    <div class="cleared"></div>
                </div>

                <div class="form-field">
                    <label for="edit_product_private_notes">{% trans 'Private notes' %}:</label>
                    <textarea id="edit_product_private_notes" maxlength="1000"></textarea>
                </div>

                <div class="form-field">
                    {% comment %} save/cancel buttons {% endcomment %}
                    <div class="split-cell first">
                        <input type="button" id="edit_product_save" value="{% trans 'Save' %}" class="ok hoverable"/>
                    </div>
                    <div class="split-cell last">
                        <input type="button" id="edit_product_cancel" value="{% trans 'Cancel' %}"
                               class="cancel hoverable"/>
                    </div>

                    <div class="cleared"></div>
                </div>
            </div>
        </div>

        {% comment %} a template for viewing products {% endcomment %}
        <div id="product_details_template" class="hidden">
            <div class="title">
                <div class="product-management">
                    <button class="product-controls product-favorite-button no-shadow hoverable"
                            title="{% trans 'Favorite this product: it will be displayed by default in terminal' %}"></button>
                    <button class="product-controls product-edit-button no-shadow hoverable"></button>
                    <button class="product-controls product-delete-button no-shadow hoverable"></button>
                </div>

                <p class="product-name"></p>
                <input type="hidden" class="product-id"/>
            </div>

            <table class="details">

                <tr>
                    <td colspan="2" class="padded"> {# category #}
                        <p class="product-category"></p>

                        <p class="details-label">{% trans 'Category' %}</p>
                    </td>
                    <td class="padded"> {# tax #}
                        <p class="product-tax"></p>

                        <p class="details-label">{% trans 'Tax' %}</p>
                    </td>
                    <td rowspan="2" class="product-image">
                        {# product image #}
                    </td>
                </tr>
                <tr>
                    <td class="padded"> {# price #}
                        <p class="product-price"></p>

                        <p class="details-label">{% trans 'Price' %}</p>
                    </td>
                    <td class="padded"> {# code #}
                        <p class="product-code"></p>

                        <p class="details-label">{% trans 'Code' %}</p>
                    </td>
                    <td class="padded"> {# shortcut #}
                        <p class="product-shortcut"></p>

                        <p class="details-label">{% trans 'Shortcut' %}</p>
                    </td>
                </tr>
            </table>
        </div>

    </div>

    {% comment %} a dummy div for creating new products {% endcomment %}
    <div id="new_product_dummy"></div>

    {% comment %} dialogs for mass editing taxes and discounts {% endcomment %}
    <div id="mass_tax_edit_dialog" class="mass-dialog hidden">
        <div>
            <select class="taxes"></select>
        </div>

        <div>
            <input type="button"
                   class="ok hoverable"
                   title="{% blocktrans %}Change all products's tax in current search results to selected{% endblocktrans %}"
                   value="{% trans 'Apply to all' %}" />
        </div>
    </div>

    <div id="mass_discount_edit_dialog" class="mass-dialog hidden">
        <div>
            <select class="discounts"></select>
        </div>

        <div>
            <input type="button"
                   class="add-discount ok hoverable"
                   title="{% blocktrans %}Add this discount to all current search results{% endblocktrans %}"
                   value="{% trans 'Add to current results' %}" />
        </div>

        <div>
            <input type="button"
                   class="remove-discount cancel hoverable"
                   title="{% blocktrans %}Remove this discount from all current search results{% endblocktrans %}"
                   value="{% trans 'Remove from all' %}" />
        </div>

        <div class="clear-discounts-container">
            <a class="clear-discounts fake" href="#"
               title="{% blocktrans %}Remove all discounts from all products in current search results{% endblocktrans %}">
                <img src="{% static 'icons/delete_red.png' %}" alt="" />
                {% trans 'Clear all discounts' %}
            </a>
        </div>
    </div>
{% endblock %}

